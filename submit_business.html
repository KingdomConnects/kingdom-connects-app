<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Submit Your Business</title>
  <link rel="stylesheet" href="styles/style.css" />
  <script defer type="module">
    // Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const churchSelect = document.getElementById("churchId");
    const form = document.getElementById("businessForm");
    const status = document.getElementById("status");

    // Load churches from Firestore
    async function loadChurches() {
      try {
        const snapshot = await getDocs(collection(db, "churches"));
        snapshot.forEach((docSnap) => {
          const option = document.createElement("option");
          option.value = docSnap.id;
          option.textContent = docSnap.data().name;
          churchSelect.appendChild(option);
        });
        console.log("Churches loaded into dropdown.");
      } catch (error) {
        console.error("Error loading churches:", error);
        status.textContent = "Error loading churches.";
        status.style.color = "red";
      }
    }

    loadChurches();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";

      const formData = {
        businessName: form.businessName.value,
        contactName: form.contactName.value,
        email: form.email.value,
        description: form.description.value,
        phone: form.phone.value,
        website: form.website.value,
        address1: form.address1.value,
        address2: form.address2.value,
        city: form.city.value,
        state: form.state.value,
        zip: form.zip.value,
        churchId: form.churchId.value,
        created_at: new Date().toISOString()
      };

      console.log("Submitting form data:", formData);

      try {
        // Check if church exists
        const churchRef = doc(db, "churches", formData.churchId);
        const churchSnap = await getDoc(churchRef);

        if (!churchSnap.exists()) {
          status.textContent = "Error: Selected church ID does not exist.";
          status.style.color = "red";
          console.error("Church not found:", formData.churchId);
          return;
        }

        await addDoc(collection(db, "businesses"), formData);
        status.textContent = "Business submitted successfully!";
        status.style.color = "green";
        console.log("Form submitted.");
        form.reset();
      } catch (error) {
        console.error("Submission error:", error);
        status.textContent = "Error: " + error.message;
        status.style.color = "red";
      }
    });
  </script>
</head>
<body>
  <div class="form-container">
    <h1>Submit Your Business</h1>
    <form id="businessForm">
      <label>Business Name</label>
      <input type="text" name="businessName" required />

      <label>Your Name</label>
      <input type="text" name="contactName" required />

      <label>Contact Email</label>
      <input type="email" name="email" required />

      <label>Brief Description</label>
      <textarea name="description" required></textarea>

      <label>Phone Number</label>
      <input type="tel" name="phone" required />

      <label>Website URL</label>
      <input type="url" name="website" />

      <label>Address Line 1</label>
      <input type="text" name="address1" required />

      <label>Address Line 2</label>
      <input type="text" name="address2" />

      <label>City</label>
      <input type="text" name="city" required />

      <label>State</label>
      <input type="text" name="state" required />

      <label>ZIP Code</label>
      <input type="text" name="zip" required />

      <label>Select Your Church</label>
      <select name="churchId" id="churchId" required>
        <option value="">-- Select a Church --</option>
      </select>

      <button type="submit">Submit</button>
      <div id="status"></div>
    </form>
  </div>
</body>
</html>